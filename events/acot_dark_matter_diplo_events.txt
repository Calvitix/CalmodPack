
#########################################
#
# on_action_events
#
#########################################

namespace = acot_diplo

event = {
    id = acot_diplo.1
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { 
                NOT = {
                    has_global_flag = acot_events_forbidden
                }
                any_country = {
                    has_technology = tech_dark_matter_power_core
                    OR = {
                        is_country_type = default
                        is_country_type = lost_empire
                        is_country_type = ascended_empire
                        is_country_type = eternal_empire
                    }
                    NOR = {  
                        is_country_type = fallen_empire
                        is_country_type = awakened_fallen_empire
                        has_country_flag = about_to_be_negotiated
                        has_valid_civic = civic_fanatic_purifiers
                        has_valid_civic = civic_machine_terminator
                        has_valid_civic = civic_hive_devouring_swarm
                    }                      
                }
            }  
            random_list = {
                70 = { }
                30 = {
                    if = {
                        limit = {
                            any_country = {
                                has_technology = tech_dark_matter_power_core
                                OR = {
                                    is_country_type = default
                                    is_country_type = lost_empire
                                    is_country_type = ascended_empire
                                    is_country_type = eternal_empire
                                }
                                NOR = {  
                                    is_country_type = fallen_empire
                                    is_country_type = awakened_fallen_empire
                                    has_country_flag = about_to_be_negotiated
                                    has_valid_civic = civic_fanatic_purifiers
                                    has_valid_civic = civic_machine_terminator
                                    has_valid_civic = civic_hive_devouring_swarm
                                }                               
                            }
                         }
                         random_country = {
                            limit = {
                                has_technology = tech_dark_matter_power_core
                                NOR = {  
                                    is_country_type = fallen_empire
                                    is_country_type = awakened_fallen_empire
                                    has_country_flag = about_to_be_negotiated
                                    has_valid_civic = civic_fanatic_purifiers
                                    has_valid_civic = civic_machine_terminator
                                    has_valid_civic = civic_hive_devouring_swarm
                                }                
                            }
                            country_event = { id = acot_diplo.2  }
                        }                       
                    }
                    else = {
                        
                    }
                }
            } 
        }
    }
}

country_event = {
    id = acot_diplo.2
    hide_window = yes
    trigger = {
        NOT = {
            has_global_flag = acot_events_forbidden
        }
        has_technology = tech_dark_matter_power_core
        OR = {
            is_country_type = default
            is_country_type = lost_empire
            is_country_type = ascended_empire
            is_country_type = eternal_empire
        }
        NOR = {  
            is_country_type = fallen_empire
            is_country_type = awakened_fallen_empire
            has_country_flag = about_to_be_negotiated
            has_valid_civic = civic_fanatic_purifiers
            has_valid_civic = civic_machine_terminator
            has_valid_civic = civic_hive_devouring_swarm
        }  
    }

    mean_time_to_happen = {
        years = 10
    }

    immediate = {
        if = {
            limit = { 
                any_country = {
                    is_ai = yes
                    is_country_type = default
                    has_established_contact = root
                    has_technology = tech_zero_point_power
                    has_technology = tech_mine_dark_matter
                    OR = {   
                        is_in_federation_with = root
                        is_friendly_to = root
                        is_cordial_to = root
                        is_neighbor_of = root
                    }
                    NOR = {
                        is_unfriendly_to = root
                        is_rival = root
                        is_hostile_to = root
                        is_disloyal_to = root
                        has_technology = tech_dark_matter_power_core
                        has_tech_option = tech_dark_matter_power_core
                        has_country_flag = delay_before_ask_dm
                    }
                }
            }
            set_country_flag = about_to_be_negotiated
            random_country = {
                limit = {
                    is_ai = yes
                    is_country_type = default
                    has_established_contact = root
                    has_technology = tech_zero_point_power
                    has_technology = tech_mine_dark_matter
                    OR = {
                        is_in_federation_with = root
                        is_friendly_to = root
                        is_cordial_to = root
                        is_neighbor_of = root
                    }
                    NOR = {
                        is_unfriendly_to = root
                        is_rival = root
                        is_hostile_to = root
                        is_disloyal_to = root
                        has_technology = tech_dark_matter_power_core
                        has_tech_option = tech_dark_matter_power_core
                        has_country_flag = delay_before_ask_dm
                    }                  
                }
                save_event_target_as = interested_buyer
            }
            country_event = { id = acot_diplo.3  }           
        }
        else = {
            
        }
    }
}

country_event = {
	id = acot_diplo.3
	title = acot_diplo.3.name
	
	is_triggered_only = yes
	diplomatic = yes
	
	picture_event_data = {
		portrait = event_target:interested_buyer
		planet_background = event_target:interested_buyer
		graphical_culture = event_target:interested_buyer
		city_level = event_target:interested_buyer
		room = event_target:interested_buyer.ruler
	}
		

	desc = {
		text = acot_diplo.3.desc.friendly
		trigger = {
			event_target:interested_buyer = { 
				OR = {
                    is_friendly_to = ROOT
                    is_cordial_to = ROOT
                    has_defensive_pact = root
                    is_in_federation_with = ROOT
				}
			}
		}
	}
	desc = {
		text = acot_diplo.3.desc.neutral
		trigger = {
			event_target:interested_buyer = { 
				NOR = {
                    is_friendly_to = ROOT
                    is_cordial_to = ROOT
                    has_defensive_pact = root
                    is_in_federation_with = ROOT
				}
			}
		}
	}


	option = {
		name = acot_diplo.3.a
        response_text = acot_diplo.3.a.response
        custom_tooltip = dm_with_assist_tooltip
        event_target:interested_buyer = { 
            add_research_option = tech_dark_matter_power_core
            set_country_flag = have_received_dm
            add_tech_progress = {
                tech = tech_dark_matter_power_core
                progress = 0.50
            }
            if = {
                limit = {
                    ROOT = {
                        has_technology = tech_dark_matter_propulsion
                    }
                 }
                 add_research_option = tech_dark_matter_propulsion
            }
            if = {
                limit = {
                    ROOT = {
                        has_technology = tech_dark_matter_deflector
                    }
                 }
                 add_research_option = tech_dark_matter_deflector
            }
            add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_with_assist }
        }
		hidden_effect = {
            every_country = {
                limit = {
                    is_country_type = default
                    OR = {
                        is_friendly_to = ROOT
                        is_cordial_to = ROOT
                        has_defensive_pact = root
                        is_in_federation_with = ROOT          
                    }
                    NOR = {
                        is_same_value = root
                        is_same_value = event_target:interested_buyer
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_with_assist_neighbour }
            }
            every_country = {
                limit = {
                    OR = {
                        is_rival = event_target:interested_buyer
                        is_unfriendly_to = event_target:interested_buyer
                        is_hostile_to = event_target:interested_buyer
                        is_overlord_to = event_target:interested_buyer           
                    }
                    NOR = {
                        is_same_value = root
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_to_enemy }
            }
			remove_country_flag = about_to_be_negotiated
        }
        
        ai_chance = {
            factor = 5
            modifier = {
                factor = 10
                OR = {
                    is_friendly_to = from
                    is_in_federation_with = from            
                }
            }
        }
	}

	option = {
		name = acot_diplo.3.b
        response_text = acot_diplo.3.b.response
        custom_tooltip = dm_with_assist_tooltip
        event_target:interested_buyer = { 
            set_country_flag = have_received_dm
            add_research_option = tech_dark_matter_power_core
            add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_normal }
        }
		hidden_effect = {
            every_country = {
                limit = {
                    is_country_type = default
                    OR = {
                        is_friendly_to = ROOT
                        is_cordial_to = ROOT
                        has_defensive_pact = root
                        is_in_federation_with = ROOT            
                    }
                    NOR = {
                        is_same_value = root
                        is_same_value = event_target:interested_buyer
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_normal_neighbour }
            }
            every_country = {
                limit = {
                    OR = {
                        is_rival = event_target:interested_buyer
                        is_unfriendly_to = event_target:interested_buyer
                        is_hostile_to = event_target:interested_buyer
                        is_overlord_to = event_target:interested_buyer           
                    }
                    NOR = {
                        is_same_value = root
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_to_enemy }
            }
			remove_country_flag = about_to_be_negotiated
        }
        
        ai_chance = {
            factor = 5
            modifier = {
                factor = 10
                OR = {
                    is_cordial_to = from        
                }
            }
        }
	}

	option = {
		name = acot_diplo.3.c
        response_text = acot_diplo.3.c.response
        custom_tooltip = dm_with_assist_tooltip
        trigger = {
            NOR = {
                has_country_flag = taught_how_to_dm
            }
        }
        add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_normal_neighbour }
        event_target:interested_buyer = { 
            set_timed_country_flag = {
                flag = delay_before_ask_dm
                days = 3600
            }
            set_country_flag = taught_how_to_dm
            random_owned_leader = {
                limit = {
                    leader_class = scientist
                    is_researching_area = society
                }
                if = {
                    limit = { 
                        has_skill <= 5 
                     }
                     set_skill = 6
                }
                if = {
                    limit = { 
                        NOT = { has_trait = leader_trait_spark_of_genius }
                     }
                     add_trait = leader_trait_spark_of_genius
                }
            }
            random_owned_leader = {
                limit = {
                    leader_class = scientist
                    is_researching_area = physics
                }
                if = {
                    limit = { 
                        has_skill <= 5 
                     }
                     set_skill = 6
                }
                if = {
                    limit = { 
                        NOT = { has_trait = leader_trait_spark_of_genius }
                     }
                     add_trait = leader_trait_spark_of_genius
                }
            }
            random_owned_leader = {
                limit = {
                    leader_class = scientist
                    is_researching_area = engineering
                }
                if = {
                    limit = { 
                        has_skill <= 5 
                     }
                     set_skill = 6
                }
                if = {
                    limit = { 
                        NOT = { has_trait = leader_trait_spark_of_genius }
                     }
                     add_trait = leader_trait_spark_of_genius
                }
            }
        }
		hidden_effect = {
			remove_country_flag = about_to_be_negotiated
        }
        
	}

	option = {
		name = acot_diplo.3.d
        response_text = acot_diplo.3.d.response
        trigger = {
            event_target:interested_buyer = { 
                OR = {
                    is_friendly_to = ROOT
                    is_cordial_to = ROOT
                    has_defensive_pact = root
                    is_in_federation_with = ROOT
                }
            }         
        }
        event_target:interested_buyer = {
            add_opinion_modifier = { who = root modifier = triggered_opinion_refuse_dm_friendly }
            if = {
                limit = { has_country_flag = asked_for_dm } 
                set_timed_country_flag = {
                    flag = delay_before_ask_dm
                    days = 3600
                }   
            }
            else = {
                set_timed_country_flag = {
                    flag = delay_before_ask_dm
                    days = 1800
                }    
                set_country_flag = asked_for_dm
                break = yes             
            }
            every_country = {
                limit = {
                    OR = {
                        is_friendly_to = ROOT
                        is_cordial_to = ROOT
                        has_defensive_pact = root
                        is_in_federation_with = ROOT                   
                    }
                    NOR = {
                        is_same_value = ROOT
                        is_same_value = event_target:interested_buyer                    
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_refuse_dm_friendly_others }
            }           
        }
		hidden_effect = {
			remove_country_flag = about_to_be_negotiated
        }
        
        ai_chance = {
            factor = 5
            modifier = {
                factor = 7
                NOR = {
                    is_cordial_to = from  
                    is_friendly_to = from
                }
            }
            modifier = {
                factor = 10
                OR = {
                    has_ethic = ethic_fanatic_xenophobe
                    has_ethic = ethic_xenophobe
                }
            }
        }
    }
    
	option = {
		name = acot_diplo.3.e
        response_text = acot_diplo.3.e.response
        trigger = {
            event_target:interested_buyer = { 
                NOR = {
                    is_friendly_to = ROOT
                    is_cordial_to = ROOT
                    has_defensive_pact = root
                    is_in_federation_with = ROOT
                }
            }         
        }

        event_target:interested_buyer = {
            add_opinion_modifier = { who = root modifier = triggered_opinion_refuse_dm_neutral }
            if = {
                limit = { has_country_flag = asked_for_dm } 
                set_timed_country_flag = {
                    flag = delay_before_ask_dm
                    days = 3600
                }   
            }
            else = {
                set_timed_country_flag = {
                    flag = delay_before_ask_dm
                    days = 1800
                }    
                set_country_flag = asked_for_dm
                break = yes             
            }
        }
		hidden_effect = {
			remove_country_flag = about_to_be_negotiated
        }
        
        ai_chance = {
            factor = 5
            modifier = {
                factor = 7
                NOR = {
                    is_cordial_to = from  
                    is_friendly_to = from
                }
            }
            modifier = {
                factor = 10
                OR = {
                    has_ethic = ethic_fanatic_xenophobe
                    has_ethic = ethic_xenophobe
                }
            }
        }
    }
    
	option = {
		name = acot_diplo.3.f
        response_text = acot_diplo.3.f.response
        trigger = {
            event_target:interested_buyer = { 
                any_owned_megastructure = {
                    is_megastructure_type = lgate_base
                }
            }         
        }
        event_target:interested_buyer = { 
            set_country_flag = have_received_dm
            add_research_option = tech_dark_matter_power_core
            add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_normal }
            random_system = {
                limit = {
                    is_owned_by = event_target:interested_buyer 
                    has_megastructure = lgate_base
                }
                random_fleet_in_system = {
                    limit = {
                        any_owned_ship = {
                            is_ship_class = shipclass_starbase
                        }
                    }
                    set_owner = ROOT
                }
                every_system_planet = {
                    limit = {
                        OR = {
                            habitable_planet = yes
                            habitable_structure = yes
                        }
                    }
                    set_owner = ROOT
                }
            }
        }
		hidden_effect = {
            every_country = {
                limit = {
                    OR = {
                        is_rival = event_target:interested_buyer
                        is_unfriendly_to = event_target:interested_buyer
                        is_hostile_to = event_target:interested_buyer
                        is_overlord_to = event_target:interested_buyer           
                    }
                    NOR = {
                        is_same_value = root
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_to_enemy }
            }
			remove_country_flag = about_to_be_negotiated
        }        
    }
    
	option = {
		name = acot_diplo.3.g
        response_text = acot_diplo.3.g.response
        trigger = {
            event_target:interested_buyer = { 
                any_owned_megastructure = {
                    is_megastructure_type = sofe_outer_gate
                }
            }         
        }
        event_target:interested_buyer = { 
            set_country_flag = have_received_dm
            add_research_option = tech_dark_matter_power_core
            add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_normal }
            random_system = {
                limit = {
                    is_owned_by = event_target:interested_buyer 
                    has_megastructure = sofe_outer_gate
                }
                random_fleet_in_system = {
                    limit = {
                        any_owned_ship = {
                            is_ship_class = shipclass_starbase
                        }
                    }
                    set_owner = ROOT
                }
                every_system_planet = {
                    limit = {
                        OR = {
                            habitable_planet = yes
                            habitable_structure = yes
                        }
                    }
                    set_owner = ROOT
                }
            }
        }
		hidden_effect = {
            every_country = {
                limit = {
                    OR = {
                        is_rival = event_target:interested_buyer
                        is_unfriendly_to = event_target:interested_buyer
                        is_hostile_to = event_target:interested_buyer
                        is_overlord_to = event_target:interested_buyer           
                    }
                    NOR = {
                        is_same_value = root
                    }
                }
                add_opinion_modifier = { who = root modifier = triggered_opinion_give_dm_to_enemy }
            }
			remove_country_flag = about_to_be_negotiated
        }        
	}
}


country_event = {
    id = acot_diplo.4
    hide_window = yes
    trigger = {
        is_country_type = default
        has_technology = tech_dark_matter_power_core
        NOR = {  
            has_ascension_perk = ap_enigmatic_engineering          
            has_country_flag = will_not_have_ambushed_ship
        }     
       NOT = {
          has_global_flag = acot_events_forbidden
        }
        any_owned_ship = {
            is_ship_class = shipclass_science_ship
            leader = {
                has_skill <= 5
            }
            NOR = {
                is_inside_border = root
                solar_system = {
                    NOR = {
                        has_owner = yes
                        any_ship_in_system = {
                            is_ship_class = shipclass_military
                        }                       
                    }
                }
            }
        }     
        any_country = {
            is_ai = yes
            is_country_type = default
            has_established_contact = root
            NOR = {
                has_country_flag = hiring_in_progress   
                is_in_federation_with = root
                is_friendly_to = root
                is_cordial_to = root
                has_technology = tech_dark_matter_power_core
            }
            OR = {
                is_unfriendly_to = root
                is_rival = root
                is_hostile_to = root
            }
        }  
   }

   mean_time_to_happen = {
       years = 10
   }

    immediate = {
        set_timed_country_flag = {
            flag = will_not_have_ambushed_ship
            days = 3600
        }
        ############SELLECT THE HIRER#############
         random_country = {
            limit = {
                is_ai = yes
                is_country_type = default
                has_established_contact = root
                NOR = {   
                    has_country_flag = hiring_in_progress   
                    is_in_federation_with = root
                    is_friendly_to = root
                    is_cordial_to = root
                    has_technology = tech_dark_matter_power_core
                }
                OR = {
                    is_unfriendly_to = root
                    is_rival = root
                    is_hostile_to = root
                }                  
            }
            save_event_target_as = raiding_hirer_country
            set_country_flag = hiring_in_progress
            capital_scope = {
                save_event_target_as = raiding_hirer_capital
                set_planet_flag = raiding_hirer_capital_planet
            }
        }
            #######RANDOM A SCIENCE SHIP################
        random_owned_ship = {
            limit = {
                is_ship_class = shipclass_science_ship
                leader = {
                    has_skill <= 5
                }
                NOR = {
                    is_inside_border = root
                    solar_system = {
                        has_owner = yes
                        any_ship_in_system = {
                            is_ship_class = shipclass_military
                        }    
                    }
                }
            }  
            save_event_target_as = kidnapped_science_ship             
        }
        ########CREATE A RAIDER####################
        create_country = {
            type = acot_techno_pirate
            name = "Pubstompah"
        }
        last_created_country = {
            save_event_target_as = pirate_of_science_ship
            set_country_flag = raider_hired_by@event_target:raiding_hirer_country
            create_fleet = {
                name = "NAME_Raiding_Fleet"
                effect = {
                    set_owner = event_target:pirate_of_science_ship # For ship names
                    create_techno_raiders_small = yes
                    set_location = event_target:kidnapped_science_ship
                    set_fleet_stance = aggressive
                    set_aggro_range_measure_from = self
                    set_aggro_range = 250
                    set_fleet_flag = science_ship_raider_fleet
                    auto_move_to_planet = {
                        target = event_target:raiding_hirer_capital
                        clear_auto_move_on_arrival = no
                    }
                }
            }
            set_faction_hostility = {
                target = root
                set_hostile = yes
                set_neutral = no
                set_friendly = no
            }
            set_faction_hostility = {
                target = event_target:raiding_hirer_country
                set_hostile = no
                set_neutral = no
                set_friendly = yes
            }
            establish_communications_no_message = root
            every_country = {
                establish_communications_no_message = event_target:pirate_of_science_ship            
            }
        }
        event_target:raiding_hirer_country = {
            set_country_flag = hirer_of@event_target:pirate_of_science_ship
        }
        destroy_ship = event_target:kidnapped_science_ship
        country_event = { id = acot_diplo.5  }        
    }
}

country_event = {
    id = acot_diplo.5
    title = acot_diplo.5.name
    desc = acot_diplo.5.desc
    picture = GFX_evt_pirates_attacking_cargo
    show_sound = event_red_alert
    is_triggered_only = yes


    immediate = {
    }

    option = {
        name = acot_diplo.5.a
        hidden_effect = {
            country_event = { id = acot_diplo.50 }
        }    
    }
}

country_event = {
	id = acot_diplo.50
	title = acot_diplo.8.name
	
	is_triggered_only = yes
	diplomatic = yes
	
	picture_event_data = {
		room = no_video_feed_room
	}
    
    desc = {
		text = acot_diplo.8.desc.a
	}
    desc = {
		text = acot_diplo.8.desc.b
	}
    desc = {
		text = acot_diplo.8.desc.c
	}

    option = {
        name = acot_diplo.8.a
        default_hide_option = yes
    }

    option = {
        name = acot_diplo.8.b
    }

}

fleet_event = {
    id = acot_diplo.6
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        OWNER = {
            is_country_type = acot_techno_pirate
        }
        FROM = {
            has_planet_flag = raiding_hirer_capital_planet
        }
    }

    immediate = {
        owner = {
            remove_country_flag = raider_hired_by@event_target:raiding_hirer_country      
            destroy_country = yes
            every_owned_fleet = {
                destroy_fleet = this
            }     
        }
        FROM = {
            remove_planet_flag = raiding_hirer_capital_planet
            owner = {
                remove_country_flag = hirer_of@event_target:pirate_of_science_ship   
                remove_country_flag = hiring_in_progress   
                give_technology = { tech = tech_dark_matter_power_core }
                give_technology = { tech = tech_dark_matter_propulsion }
                give_technology = { tech = tech_dark_matter_deflector }               
            }
        }
    }

}