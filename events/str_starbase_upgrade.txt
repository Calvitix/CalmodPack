namespace = str_starbase_fix

#Apparently there exists a new 2.6.* "feature" where AI won't upgrade starbases if it doesn't have free starbase cap.
#This event is a workaround which will upgrade them (while subtracting necessary alloy count).


country_event = {
    id = str_starbase_fix.1
    hide_window = yes
    is_triggered_only = yes
    immediate = {
		if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix.1 begin for [This.GetName]" }
        if = {
            limit = {
				#is_at_war = no
                resource_stockpile_compare = {
                    resource = alloys
                    value > 4000
                }
                #used_naval_capacity_percent > 0.6 # 0.95
                has_technology = tech_starbase_5
                #any_owned_starbase = {
                #    has_starbase_size = starbase_starfortress
                #}
			}
			country_event = {
				id = str_starbase_fix.31
			}
		}
		if = {
            limit = {
				#is_at_war = no
                resource_stockpile_compare = {
                    resource = alloys
                    value > 2000
                }
                #used_naval_capacity_percent > 0.6 # 0.95
                has_technology = tech_starbase_4
                #any_owned_starbase = {
                #    has_starbase_size = starbase_starhold
                #}
			}
			country_event = {
				id = str_starbase_fix.3
			}
		}
		if = {
            limit = {
				#is_at_war = no
                resource_stockpile_compare = {
                    resource = alloys
                    value > 900 #800
                }
                #used_naval_capacity_percent > 0.6 # 0.8
                has_technology = tech_starbase_3
                #any_owned_starbase = {
                #    has_starbase_size = starbase_starport
                #}
			}
			country_event = {
				id = str_starbase_fix.2
			}
		}
    }
}

country_event = {
	id = str_starbase_fix.2
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		random_owned_starbase = {
			limit = { has_starbase_size = starbase_starport }
			set_starbase_size = starbase_starhold
			#remove_starbase_module = { slot = 5 }
			#remove_starbase_module = { slot = 6 }
			#set_starbase_module = {
			#	slot = 5
			#	module = gun_battery
			#}			
			#set_starbase_module = {
			#	slot = 6
			#	module = pd_battery
			#}			
			owner = {
				add_resource = {
					alloys = -600
				}
			}
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Upgrading to StarHold on planet [This.GetName] for [Owner.GetName]" }

		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starhold
						NOT = { has_starbase_module = gun_battery }
					}
			remove_starbase_module = { slot = 7 }
			set_starbase_module = {
				slot = 7
				module = gun_battery
			}
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding gun_battery on slot 7 on planet [This.GetName] for [Owner.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starhold
						NOT = { has_starbase_module = pd_battery }
					}
			remove_starbase_module = { slot = 6 }				
			set_starbase_module = {
				slot = 6
				module = pd_battery
			}			
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding pd_battery on slot 6 on planet [This.GetName] for [Owner.GetName]" }			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starhold
						NOT = { has_starbase_building = target_uplink_computer }
					}
			remove_starbase_building = { slot = 6 }				
			set_starbase_building = {
				slot = 6
				building = target_uplink_computer
			}	
			owner = {
				add_resource = {
					alloys = -100
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding target_uplink_computer on slot 6 on planet [This.GetName] for [Owner.GetName]" }			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starhold
						NOT = { has_starbase_building = mzilli_battle_debris_recycling_center }
					}
			remove_starbase_building = { slot = 5 }				
			set_starbase_building = {
				slot = 5
				building = mzilli_battle_debris_recycling_center
			}					
			owner = {
				add_resource = {
					alloys = -10
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding mzilli_battle_debris_recycling_center on slot 5 on planet [This.GetName] for [Owner.GetName]" }			
		}						
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starhold
						NOT = { has_starbase_building = solar_panel_02 }
					}
			remove_starbase_building = { slot = 7 }				
			set_starbase_building = {
				slot = 7
				building = solar_panel_02
			}					
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding solar_panel_02 on slot 7 on planet [This.GetName] for [Owner.GetName]" }			
		}						
	}
}

country_event = {
	id = str_starbase_fix.3
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix 3.Try to find StarHold to Upgrade" }
		random_owned_starbase = {
			limit = { has_starbase_size = starbase_starhold }
			set_starbase_size = starbase_starfortress
			#remove_starbase_module = { slot = 5 }
			#remove_starbase_module = { slot = 6 }
			#set_starbase_module = {
			#	slot = 5
			#	module = gun_battery
			#}			
			#set_starbase_module = {
			#	slot = 6
			#	module = pd_battery
			#}						
			owner = {
				add_resource = {
					alloys = -1350
				}
			}
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Upgrading to StarFortress on planet [This.GetName] for [Owner.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starfortress
						NOT = { has_starbase_module = gun_battery }
					}
			remove_starbase_module = { slot = 9 }
			set_starbase_module = {
				slot = 9
				module = gun_battery
			}			
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding gun_battery on slot 9 on planet [This.GetName] for [Owner.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starfortress
						NOT = { has_starbase_module = pd_battery }
					}
			remove_starbase_module = { slot = 10 }
			set_starbase_module = {
				slot = 10
				module = pd_battery
			}		
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding pd_battery on slot 10 on planet [This.GetName] for [Owner.GetName]" }			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starfortress
						NOT = { has_starbase_building = target_uplink_computer }
					}
			remove_starbase_building = { slot = 9 }				
			set_starbase_building = {
				slot = 9
				building = target_uplink_computer
			}					
			owner = {
				add_resource = {
					alloys = -100
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding target_uplink_computer on slot 9 on planet [This.GetName] for [Owner.GetName]" }			
		}	
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_starfortress
						NOT = { has_starbase_building = solar_panel_03 }
					}
			remove_starbase_building = { slot = 10 }				
			set_starbase_building = {
				slot = 10
				building = solar_panel_03
			}					
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding solar_panel_03 on slot 10 on planet [This.GetName] for [Owner.GetName]" }			
		}		
	}
}

country_event = {
	id = str_starbase_fix.31
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix 31.Try to find StarFortress to Upgrade" }
		random_owned_starbase = {
			limit = { has_starbase_size = starbase_starfortress 
						or = { #calvitix, AI should have construct Defenses
							count_starbase_modules = {
								type = gun_battery
								count > 1
							}
							count_starbase_modules = {
								type = pd_battery
								count > 1
							}
						}
			}
			set_starbase_size = starbase_citadel
			#remove_starbase_module = { slot = 5 }
			#remove_starbase_module = { slot = 6 }
			#set_starbase_module = {
			#	slot = 5
			#	module = gun_battery
			#}			
			#set_starbase_module = {
			#	slot = 6
			#	module = pd_battery
			#}						
			owner = {
				add_resource = {
					alloys = -3800
				}
			}
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Upgrading to StarCitadel on planet [This.GetName] for [Owner.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_citadel
						NOT = { has_starbase_module = large_battery }
					}
			remove_starbase_module = { slot = 13 }
			set_starbase_module = {
				slot = 13
				module = large_battery
			}			
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding large_battery on slot 13 on planet [This.GetName] for [Owner.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_citadel
						NOT = { has_starbase_module = missile_battery }
					}
			remove_starbase_module = { slot = 14 }
			set_starbase_module = {
				slot = 14
				module = missile_battery
			}		
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding missile_battery on slot 14 on planet [This.GetName] for [Owner.GetName]" }			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_citadel
						NOT = { has_starbase_building = target_uplink_computer }
					}
			remove_starbase_building = { slot = 13 }				
			set_starbase_building = {
				slot = 13
				building = nsc_nanite_field
			}					
			owner = {
				add_resource = {
					alloys = -100
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding nsc_nanite_field on slot 13 on planet [This.GetName] for [Owner.GetName]" }			
		}	
		random_owned_starbase = {
			limit = { 
						has_starbase_size >= starbase_citadel
						NOT = { has_starbase_building = solar_panel_04 }
					}
			remove_starbase_building = { slot = 14 }				
			set_starbase_building = {
				slot = 14
				building = solar_panel_04
			}					
			owner = {
				add_resource = {
					alloys = -50
				}
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Adding solar_panel_04 on slot 14 on planet [This.GetName] for [Owner.GetName]" }			
		}		
	}
}


country_event = {
	id = str_starbase_fix.4
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				used_naval_capacity_percent > 0.85
			}
			random_owned_starbase = {
				limit = {
					has_starbase_module = orbital_lab
				}
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Remove orbital_lab on planet [This.GetName] for [Owner.GetName]" }
				
			}
		}
		if = {
			limit = {
				has_technology = tech_alloys_1
			}
			random_owned_starbase = {
				limit = {
					has_starbase_module = orbital_lab
					solar_system = {
						any_system_planet = {
							or = {
								has_designation = col_factory
								has_designation = col_foundry
							}
						}
					}
				}
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix Remove orbital_lab on planet [This.GetName] for [Owner.GetName]" }
				
			}
		}
	}
}
