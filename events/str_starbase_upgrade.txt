namespace = str_starbase_fix

#Apparently there exists a new 2.6.* "feature" where AI won't upgrade starbases if it doesn't have free starbase cap.
#This event is a workaround which will upgrade them (while subtracting necessary alloy count).


country_event = {
    id = str_starbase_fix.1
    hide_window = yes
    is_triggered_only = yes
    immediate = {
		if = { limit = { has_global_flag = edai_logging	} log = "STR: Starfix.1 begin for [This.GetName]" }
        if = {
            limit = {
				#is_at_war = no
                resource_stockpile_compare = {
                    resource = alloys
                    value > 900 #800
                }
                #used_naval_capacity_percent > 0.6 # 0.8
                has_technology = tech_starbase_3
                any_owned_starbase = {
                    has_starbase_size = starbase_starport
                }
			}
			country_event = {
				id = str_starbase_fix.2
			}
		}
		else_if = {
            limit = {
				#is_at_war = no
                resource_stockpile_compare = {
                    resource = alloys
                    value > 2000
                }
                #used_naval_capacity_percent > 0.6 # 0.95
                has_technology = tech_starbase_4
                any_owned_starbase = {
                    has_starbase_size = starbase_starhold
                }
			}
			country_event = {
				id = str_starbase_fix.3
			}
		}
    }
}

country_event = {
	id = str_starbase_fix.2
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		random_owned_starbase = {
			limit = { has_starbase_size = starbase_starport }
			set_starbase_size = starbase_starhold
			remove_starbase_module = { slot = 3 }
			remove_starbase_module = { slot = 4 }
			set_starbase_module = {
				slot = 3
				module = gun_battery
			}			
			set_starbase_module = {
				slot = 4
				module = pd_battery
			}			
			owner = {
				add_resource = {
					alloys = -600
				}
			}
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding StarHold for [This.GetName]" }

		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size = starbase_starhold
						NOT = { has_starbase_module = gun_battery }
					}
			remove_starbase_module = { slot = 5 }
			set_starbase_module = {
				slot = 5
				module = gun_battery
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding gun_battery on slot 5 for [This.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size = starbase_starhold
						NOT = { has_starbase_module = pd_battery }
					}
			remove_starbase_module = { slot = 6 }				
			set_starbase_module = {
				slot = 6
				module = pd_battery
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding pd_battery on slot 6 for [This.GetName]" }			
		}
		
	}
}

country_event = {
	id = str_starbase_fix.3
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		random_owned_starbase = {
			limit = { has_starbase_size = starbase_starhold }
			set_starbase_size = starbase_starfortress
			remove_starbase_module = { slot = 0 }
			remove_starbase_module = { slot = 1 }
			set_starbase_module = {
				slot = 0
				module = gun_battery
			}			
			set_starbase_module = {
				slot = 1
				module = pd_battery
			}						
			owner = {
				add_resource = {
					alloys = -1350
				}
			}
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding StarFortress for [This.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size = starbase_starfortress
						NOT = { has_starbase_module = gun_battery }
					}
			remove_starbase_module = { slot = 9 }
			set_starbase_module = {
				slot = 9
				module = gun_battery
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding gun_battery on slot 9 for [This.GetName]" }
			
		}
		random_owned_starbase = {
			limit = { 
						has_starbase_size = starbase_starfortress
						NOT = { has_starbase_module = pd_battery }
					}
			remove_starbase_module = { slot = 10 }
			set_starbase_module = {
				slot = 10
				module = pd_battery
			}			
			if = { limit = { has_global_flag = edai_logging	} log = "STR: Adding pd_battery on slot 10 for [This.GetName]" }			
		}
		
	}
}

country_event = {
	id = str_starbase_fix.4
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				used_naval_capacity_percent > 0.85
			}
			random_owned_starbase = {
				limit = {
					has_starbase_module = orbital_lab
				}
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				if = { limit = { has_global_flag = edai_logging	} log = "STR: Remove orbital_lab for [This.GetName]" }
				
			}
		}
		if = {
			limit = {
				has_technology = tech_alloys_1
			}
			random_owned_starbase = {
				limit = {
					has_starbase_module = orbital_lab
					solar_system = {
						any_system_planet = {
							or = {
								has_designation = col_factory
								has_designation = col_foundry
							}
						}
					}
				}
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				remove_starbase_module = { module = orbital_lab }
				if = { limit = { has_global_flag = edai_logging	} log = "STR: Remove orbital_lab for [This.GetName]" }
				
			}
		}
	}
}
