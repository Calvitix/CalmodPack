############################
#
# Crisis Events
#
# Written by Henrik Eklund and Miranda van den Brink
#
############################

namespace = crisis

# Prethoryn
# Prethoryn Invasion Begins (HIDDEN)
country_event = {
	id = crisis.10
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	
	immediate = {
		endgame_telemetry = prethoryn
		set_global_flag = prethoryn_subspace_echoes
		set_global_flag = prethoryn_invasion_happened
		set_global_flag = galactic_crisis_happened
		observer_event = { id = observer.27 }
		every_country = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				NOT = { has_event_chain = coming_storm_chain }
			}
			country_event = { id = crisis.11 }
		}
		if = {
			limit = {
				any_country = { has_country_flag = spy_orb_spots_crisis }
			}
			random_rim_system = {
				limit = {
					OR = {
						# No owner or neighbors
						NOT = {
							any_neighbor_system = {
								exists = space_owner
							}
							exists = space_owner
						}
						# Owned but not by fallen empire
						AND = {
							exists = space_owner
							space_owner = {
								NOR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
					# No neighboring fallen empires
					NOT = {
						any_neighbor_system = {
							exists = space_owner
							space_owner = {	
								OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
				}
				set_star_flag = swarm_invasion_target_1
			}
			every_country = {
				limit = { has_country_flag = spy_orb_spots_crisis }
				country_event = { id = megaexpanded.2 }
			}
		}
	}
}

# Approaching the Outer Rim (HIDDEN)
country_event = {
	id = crisis.12
	hide_window = yes
	fire_only_once = yes
	
	mean_time_to_happen = {
		months = 600
	}
	
	trigger = {
		OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
		has_global_flag = prethoryn_subspace_echoes
	}
	
	immediate = {
		remove_global_flag = prethoryn_subspace_echoes
		set_global_flag = prethoryn_approaching_rim
		if = {
			limit = {
				NOT = { any_country = { has_country_flag = spy_orb_spots_crisis } }
			}
			random_rim_system = {
				limit = {
					OR = {
						# No owner or neighbors
						NOR = {
							any_neighbor_system = {
								exists = space_owner
							}
							exists = space_owner
						}
						# Owned but not by fallen empire
						AND = {
							exists = space_owner
							space_owner = {
								NOR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
					# No neighboring fallen empires
					NOT = {
						any_neighbor_system = {
							exists = space_owner
							space_owner = {
								OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
				}
				set_star_flag = swarm_invasion_target_1
			}
		}
		observer_event = { id = observer.28 }
		every_country = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				NOT = { has_country_flag = spy_orb_spots_crisis }
			}
			country_event = { id = crisis.13 }
		}
		every_country = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				has_country_flag = spy_orb_spots_crisis
			}
			country_event = { id = megaexpanded.3 }
		}
	}
}

# Vanguard Arrives (HIDDEN)
country_event = {
	id = crisis.17
	hide_window = yes
	fire_only_once = yes

	mean_time_to_happen = {
		months = 30
	}

	trigger = {
		has_global_flag = prethoryn_transmission
	}

	immediate = {
		set_crisis_sound = swarm_crisis_ambient_stage_1
		set_crisis_stage_1 = yes
		awaken_guardians_of_the_galaxy = yes

		remove_global_flag = prethoryn_approaching_rim
		set_global_flag = prethoryn_arrival
		observer_event = { id = observer.29 }
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.18 }
		}
		random_rim_system = {
			limit = { has_star_flag = swarm_invasion_target_1 }
			random_system_planet = {
				create_species = {
					name = "NAME_Prethoryn"
					plural = "NAME_Prethoryns" # Correction de bug
					adjective = "NAME_Prethoryn" # Correction de bug
					class = SWARM
					namelist = Prethoryn
					portrait = random
					traits = random
					immortal = yes

					effect = { save_event_target_as = prethoryn_species }
				}
				create_country = {
					name = "NAME_Prethoryn_Scourge"
					type = "swarm"
					species = event_target:prethoryn_species
					name_list = "Prethoryn"
					flag = {
						icon= {
							category = "special"
							file = "the_swarm.dds"
						}
						background= {
							category = "backgrounds"
							file = "new_dawn.dds"
						}
						colors={
							"orange"
							"grey"
							"null"
							"null"
						}
					}
					effect = {
						save_event_target_as = prethoryn
						save_event_target_as = prethoryn_vgrd
						create_ship_design = { design = "NAME_Swarm_Transport" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Swarm_Colonizer" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Swarm_Constructor" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Swarm_Starbase" }
						add_ship_design = last_created_design
					}
				}
				solar_system = {
					if = {
						limit = {
							any_ship_in_system = {
								is_ship_class = shipclass_starbase
							}
						}
						random_fleet_in_system = {
							limit = {
								any_owned_ship = {
									is_ship_class = shipclass_starbase
								}
							}
							destroy_fleet = this
						}
					}
					create_starbase = {
						size = starbase_swarm
						owner = event_target:prethoryn_vgrd
					}
					star = {
						create_ambient_object = {
							type = "swarm_1"
							location = this
						}
						last_created_ambient_object = {
							set_ambient_object_flag = swarm_system_effect
							set_location = {
								target = prev
								distance = 0
								angle = random
							}
						}
					}
				}
				every_country = {
					limit = {
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
					}
					establish_communications_no_message = event_target:prethoryn
					add_opinion_modifier = {
						who = event_target:prethoryn
						modifier = opinion_swarm
					}
					event_target:prethoryn = {
						add_opinion_modifier = {
							who = PREV
							modifier = opinion_prey
						}
					}
				}
				event_target:prethoryn = {

					### FIRST SYSTEM

					swarm_vanguard = yes
					swarm_vanguard = yes
					swarm_vanguard = yes

					# Constructor
					create_fleet = {
						name = "NAME_Prethoryn_Constructor"
						effect = {
							set_owner = PREV
							create_ship = {
								name = random
								design = "NAME_Swarm_Constructor"
								graphical_culture = "swarm_01"
							}
							set_location = {
								target = PREVPREV
								distance = 10
								angle = random
							}
							set_fleet_stance = evasive
						}
					}
				}
			}

			### SECOND SYSTEM
			random_system = {
				limit = {
					distance = {
						source = PREV
						max_distance <= 60
						min_distance >= 5
					}
				}
				set_star_flag = swarm_invasion_target_2
				random_system_planet = {
					event_target:prethoryn = {

						swarm_vanguard = yes
						swarm_vanguard = yes
						swarm_vanguard = yes

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}
					}
				}
			}

			### THIRD SYSTEM
			random_system = {
				limit = {
					distance = {
						source = PREV
						max_distance <= 60
						min_distance >= 5
					}
					NOR = {
						has_star_flag = swarm_invasion_target_1
						has_star_flag = swarm_invasion_target_2
					}
				}
				set_star_flag = swarm_invasion_target_3
				random_system_planet = {
					event_target:prethoryn = {

						swarm_vanguard = yes
						swarm_vanguard = yes
						swarm_vanguard = yes

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}
					}
				}
			}

			### FOURTH SYSTEM
			random_system = {
				limit = {
					distance = {
						source = PREV
						max_distance <= 60
						min_distance >= 5
					}
					NOR = {
						has_star_flag = swarm_invasion_target_1
						has_star_flag = swarm_invasion_target_2
						has_star_flag = swarm_invasion_target_3
					}
				}
				set_star_flag = swarm_invasion_target_4
				random_system_planet = {
					event_target:prethoryn = {

						swarm_vanguard = yes
						swarm_vanguard = yes
						swarm_vanguard = yes

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}
					}
				}
			}
		}
		random_country = {
			limit = { is_country_type = global_event }
			country_event = { id = crisis.19 days = 400 random = 200 }
		}
	}
}


# Vanguard Arrives
country_event = {
	id = crisis.18
	title = "crisis.18.name"
	desc = "crisis.18.desc"
	picture = GFX_evt_physics_research
	show_sound = event_alien_nature
	location = event_target:prethoryn_invasion_system

	is_triggered_only = yes

	immediate = {
		random_rim_system = {
			limit = { has_star_flag = swarm_invasion_target_1 }
			save_event_target_as = prethoryn_invasion_system
		}
	}

	option = {
		name = crisis.18.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_ethic = ethic_gestalt_consciousness
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
	}
	option = {
		name = crisis.18.h
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	option = {
		name = crisis.18.i
		trigger = {
			has_ethic = "ethic_fanatic_authoritarian"
		}
	}
	option = {
		name = crisis.18.j
		trigger = {
			has_ethic = "ethic_fanatic_egalitarian"
		}
	}
	
	after = {
		end_event_chain = "coming_storm_chain"
		begin_event_chain = {
			event_chain = "prethoryn_scourge_chain"
			target = ROOT
		}
	}
}

# Main Invasion Arrives (HIDDEN)
country_event = {
	id = crisis.19
	hide_window = yes
	fire_only_once = yes

	is_triggered_only = yes

	immediate = {
		set_crisis_sound = swarm_crisis_ambient_stage_2
		set_crisis_stage_2 = yes
		set_global_flag = prethoryn_main_invasion
		set_global_flag = ongoing_prethoryn_invasion
		observer_event = { id = observer.30 }
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.20 }
		}

		# Recreate Prethoryn if Vanguard was destroyed
		if = {
			limit = {
				NOT = { exists = event_target:prethoryn }
			}
			create_species = {
				name = "NAME_Prethoryn"
				plural = "NAME_Prethoryns" # Correction de bug
				adjective = "NAME_Prethoryn" # Correction de bug
				class = SWARM
				namelist = Prethoryn
				portrait = random
				traits = random
				immortal = yes
				effect = { save_event_target_as = prethoryn_species }
			}
			create_country = {
				name = "NAME_Prethoryn_Scourge"
				type = "swarm"
				species = event_target:prethoryn_species
				name_list = "Prethoryn"
				flag = {
					icon= {
						category = "special"
						file = "the_swarm.dds"
					}
					background= {
						category = "backgrounds"
						file = "new_dawn.dds"
					}
					colors={
						"orange"
						"grey"
						"null"
						"null"
					}
				}
				effect = {
					save_event_target_as = prethoryn
					save_event_target_as = prethoryn_vgrd
					create_ship_design = { design = "NAME_Swarm_Transport" }
					add_ship_design = last_created_design
					create_ship_design = { design = "NAME_Swarm_Colonizer" }
					add_ship_design = last_created_design
					create_ship_design = { design = "NAME_Swarm_Constructor" }
					add_ship_design = last_created_design
					create_ship_design = { design = "NAME_Swarm_Starbase" }
					add_ship_design = last_created_design
				}
			}
			every_country = {
				limit = {
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
						is_country_type = awakened_fallen_empire
					}
				}
				establish_communications_no_message = event_target:prethoryn
				add_opinion_modifier = {
					who = event_target:prethoryn
					modifier = opinion_swarm
				}
				event_target:prethoryn = {
					add_opinion_modifier = {
						who = PREV
						modifier = opinion_prey
					}
				}
			}
		}

		random_rim_system = {
			limit = { has_star_flag = swarm_invasion_target_1 }

			if = {
				limit = {
					event_target:prethoryn = {
						NOT = { 
							any_owned_ship = { is_ship_class = shipclass_starbase } 
						}
					}
					any_fleet_in_system = { is_ship_class = shipclass_starbase }
				}
				random_fleet_in_system = {
					limit = {
						any_owned_ship = { is_ship_class = shipclass_starbase }
					}
					destroy_fleet = this
				}
			}
			create_starbase = {
				size = starbase_swarm
				owner = event_target:prethoryn
			}

			random_system_planet = {
				save_event_target_as = spawn_location
				event_target:prethoryn = {

					### FIRST SYSTEM
					swarm_brood = yes
					swarm_brood = yes
					swarm_brood = yes

					# Infestors
					while = {
						count = 3
						create_fleet = {
							name = "NAME_Prethoryn_Infestor"
							effect = {
								set_owner = event_target:prethoryn
								create_ship = {
									name = random
									design = "NAME_Swarm_Colonizer"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
							}
						}
					}

					# Constructor
					create_fleet = {
						name = "NAME_Prethoryn_Constructor"
						effect = {
							set_owner = event_target:prethoryn
							create_ship = {
								name = random
								design = "NAME_Swarm_Constructor"
								graphical_culture = "swarm_01"
							}
							set_location = {
								target = PREVPREV
								distance = 10
								angle = random
							}
							set_fleet_stance = evasive
						}
					}

					# Army Transports
					swarm_armies = yes
					swarm_armies = yes
					swarm_armies = yes
				}
			}

			### SECOND SYSTEM
			random_system = {
				limit = { has_star_flag = swarm_invasion_target_2 }
				if = {
					limit = {
						any_ship_in_system = {
							is_ship_class = shipclass_starbase
						}
					}
					random_fleet_in_system = {
						limit = {
							any_owned_ship = {
								is_ship_class = shipclass_starbase
							}
						}
						destroy_fleet = this
					}
				}
				create_starbase = {
					size = starbase_swarm
					owner = event_target:prethoryn
				}
				random_system_planet = {
					save_event_target_as = spawn_location
					event_target:prethoryn = {

						swarm_brood = yes
						swarm_brood = yes
						swarm_brood = yes

						# Infestors
						while = {
							count = 3
							create_fleet = {
								name = "NAME_Prethoryn_Infestor"
								effect = {
									set_owner = event_target:prethoryn
									create_ship = {
										name = random
										design = "NAME_Swarm_Colonizer"
										graphical_culture = "swarm_01"
									}
									set_location = {
										target = PREVPREV
										distance = 10
										angle = random
									}
								}
							}
						}

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = event_target:prethoryn
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}

						# Army Transports
						swarm_armies = yes
						swarm_armies = yes
						swarm_armies = yes
					}
				}
			}

			### THIRD SYSTEM
			random_system = {
				limit = { has_star_flag = swarm_invasion_target_3 }
				if = {
					limit = {
						any_ship_in_system = {
							is_ship_class = shipclass_starbase
						}
					}
					random_fleet_in_system = {
						limit = {
							any_owned_ship = {
								is_ship_class = shipclass_starbase
							}
						}
						destroy_fleet = this
					}
				}
				create_starbase = {
					size = starbase_swarm
					owner = event_target:prethoryn
				}
				random_system_planet = {
					save_event_target_as = spawn_location
					event_target:prethoryn = {

						swarm_brood = yes
						swarm_brood = yes
						swarm_brood = yes

						# Infestors
						while = {
							count = 3
							create_fleet = {
								name = "NAME_Prethoryn_Infestor"
								effect = {
									set_owner = event_target:prethoryn
									create_ship = {
										name = random
										design = "NAME_Swarm_Colonizer"
										graphical_culture = "swarm_01"
									}
									set_location = {
										target = PREVPREV
										distance = 10
										angle = random
									}
								}
							}
						}

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = event_target:prethoryn
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}

						# Army Transports
						create_fleet = {
							name = "NAME_Prethoryn_Armies"
							effect = {
								set_owner = event_target:prethoryn
								while = {
									count = 3
									create_army_transport = {
										ship_name = "NAME_Prethoryn_Transport"
										graphical_culture = "swarm_01"
										army_name = "NAME_Prethoryn_Invaders"
										army_type = "swarm_army"
										species = event_target:prethoryn_species
									}
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
							}
						}
						swarm_armies = yes
						swarm_armies = yes
						swarm_armies = yes
					}
				}
			}

			### FOURTH SYSTEM
			random_system = {
				limit = { has_star_flag = swarm_invasion_target_4 }
				if = {
					limit = {
						any_ship_in_system = {
							is_ship_class = shipclass_starbase
						}
					}
					random_fleet_in_system = {
						limit = {
							any_owned_ship = {
								is_ship_class = shipclass_starbase
							}
						}
						destroy_fleet = this
					}
				}
				create_starbase = {
					size = starbase_swarm
					owner = event_target:prethoryn
				}
				random_system_planet = {
					save_event_target_as = spawn_location
					event_target:prethoryn = {
						swarm_brood = yes
						swarm_brood = yes
						swarm_brood = yes

						# Infestors
						while = {
							count = 3
							create_fleet = {
								name = "NAME_Prethoryn_Infestor"
								effect = {
									set_owner = event_target:prethoryn
									create_ship = {
										name = random
										design = "NAME_Swarm_Colonizer"
										graphical_culture = "swarm_01"
									}
									set_location = {
										target = PREVPREV
										distance = 10
										angle = random
									}
								}
							}
						}

						# Constructor
						create_fleet = {
							name = "NAME_Prethoryn_Constructor"
							effect = {
								set_owner = event_target:prethoryn
								create_ship = {
									name = random
									design = "NAME_Swarm_Constructor"
									graphical_culture = "swarm_01"
								}
								set_location = {
									target = PREVPREV
									distance = 10
									angle = random
								}
								set_fleet_stance = evasive
							}
						}

						# Army Transports
						swarm_armies = yes
						swarm_armies = yes
						swarm_armies = yes
					}
				}
			}
		}
	}
}

# Feral Prethoryn (HIDDEN)
event = {
	id = crisis.120
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		has_global_flag = feral_prethoryn_can_spawn
		any_country = {
			AND = {
				is_country_type = global_event
				check_variable = {
					which = "feral_prethoryn_spawned"
					value < 10
				}
			}
		}
		any_system = {
			AND = {
				has_owner = no
				any_system_planet = { has_planet_flag = previously_infested }
				NOT = { has_star_flag = feral_prethoryn_system }
			}
		}
	}

	immediate = {
		random_list = {
			10 = {
				random_country = {
					limit = { is_country_type = global_event }
					change_variable = {
						which = "feral_prethoryn_spawned"
						value = 1
					}
				}
				if = {
					limit = {
						NOT = {
							any_country = { is_country_type = feral_prethoryn }
						}
					}
					random_system = {
						limit = {
							has_owner = no
							any_system_planet = { has_planet_flag = previously_infested }
							NOT = { has_star_flag = feral_prethoryn_system }
						}
						set_star_flag = feral_prethoryn_system
						save_event_target_as = feral_prethoryn_system
						create_species = {
							name = "NAME_Prethoryn"
							plural = "NAME_Prethoryns" # Correction de bug
							adjective = "NAME_Prethoryn" # Correction de bug
							class = SWARM
							namelist = Prethoryn
							portrait = random
							traits = random
							immortal = yes

							effect = { save_event_target_as = feral_prethoryn_species }
						}
						create_country = {
							name = "NAME_Feral_Prethoryn"
							type = "feral_prethoryn"
							species = event_target:feral_prethoryn_species
							name_list = "Prethoryn"
							flag = {
								icon= {
									category = "special"
									file = "the_swarm.dds"
								}
								background= {
									category = "backgrounds"
									file = "new_dawn.dds"
								}
								colors={
									"red_orange"
									"grey"
									"null"
									"null"
								}
							}
							effect = {
								save_global_event_target_as = feral_prethoryn
								create_ship_design = { design = "NAME_Swarm_Starbase" }
								add_ship_design = last_created_design
							}
						}
						create_starbase = {
							size = starbase_swarm
							owner = event_target:feral_prethoryn
						}
						random_system_planet = {
							feral_prethoryn_garrison_1 = yes
						}
						random_system_planet = {
							feral_prethoryn_garrison_1 = yes
						}
						random_system_planet = {
							feral_prethoryn_garrison_2 = yes
						}
						every_country = {
							establish_communications_no_message = event_target:feral_prethoryn
						}
						if = {
							limit = {
								NOT = { has_global_flag = feral_prethoryn_appeared }
							}
							every_country = {
								limit = { is_ai = no }
								country_event = { id = crisis.121 }
							}
						}
						set_global_flag = feral_prethoryn_appeared
					}
					break = yes
				}
				if = {
					limit = {
						any_country = { is_country_type = feral_prethoryn }
					}
					random_system = {
						limit = {
							has_owner = no
							any_system_planet = { has_planet_flag = previously_infested }
							NOT = { has_star_flag = feral_prethoryn_system }
						}
						set_star_flag = feral_prethoryn_system
						save_event_target_as = feral_prethoryn_system
						create_starbase = {
							size = starbase_swarm
							owner = event_target:feral_prethoryn
						}
						random_system_planet = {
							feral_prethoryn_garrison_1 = yes
						}
						random_system_planet = {
							feral_prethoryn_garrison_2 = yes
						}
					}
				}
			}
			90 = {}
		}
	}
}

# Purge Complete
planet_event = {
	id = crisis.202
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		num_pops = 1 # Last Pop is still alive when this event is fired
		controller = { is_country_type = "swarm" }
	}

	immediate = {
		if = {
			limit = {
				NOR = {
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_habitat # habitats are currently uninfestable
				}
			}
			change_pc = pc_infested
			set_owner = controller
			planet_event = { id = crisis.215 }
		}
		else_if = {
			# Habitable Ring Worlds can't be infested...
			# they are destroyed instead
			limit = { is_planet_class = pc_ringworld_habitable }
			destroy_colony = yes
			change_pc = pc_ringworld_habitable_damaged
			reset_planet = yes
		}
		else_if = {
			limit = { is_planet_class = pc_habitat }
			ariphaos_patch_remove_habitat = yes
		}
	}
}

# Planet Colonized
planet_event = {
	id = crisis.203
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		owner = { is_country_type = "swarm" }
	}

	immediate = {
		every_owned_pop = { kill_pop = yes }
		if = {
			limit = {
				NOR = {
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_habitat # habitats are currently uninfestable
				}
			}
			change_pc = pc_infested
			reset_planet = yes
			planet_event = { id = crisis.215 }
		}
		else_if = {
			# Habitable Ring Worlds can't be infested...
			# they are destroyed instead
			limit = { is_planet_class = pc_ringworld_habitable }
			change_pc = pc_ringworld_habitable_damaged
			reset_planet = yes
		}
		else_if = {
			limit = { is_planet_class = pc_habitat }
			ariphaos_patch_remove_habitat = yes
		}
	}
}

# Spawn Constructors if less than 6 are available, on_yearly_pulse
event = {
	id = crisis.205
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		any_country = {
			is_country_type = "swarm"
			num_ships > 10
			count_owned_ship = {
				limit = { is_ship_size = construction_ship_swarm }
				count < 6
			}
		}
	}

	immediate = {
		random_country = {
			limit = { is_country_type = swarm }
			if = {
				limit = {
					NOT = {
						exists = event_target:prethoryn
					}
				}
				save_event_target_as = prethoryn
			}
			random_owned_ship = {
				save_event_target_as = constructor_respawn_system
			}
			while = {
				count = 3
				create_fleet = {
					name = "NAME_Prethoryn_Constructor"
					effect = {
						set_owner = event_target:prethoryn
						create_ship = {
							name = random
							design = "NAME_Swarm_Constructor"
							graphical_culture = "swarm_01"
						}
						set_location = {
							target = event_target:constructor_respawn_system
							distance = 5
							angle = random
						}
						set_fleet_stance = evasive
					}
				}
			}
		}
	}
}

# Build new fleet
country_event = {
	id = crisis.207
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		save_event_target_as = prethoryn
		owner_species = { save_event_target_as = prethoryn_species }


		random_system_within_border = {
			limit = { exists = starbase }
			starbase = { save_event_target_as = spawn_location }
		}
		swarm_brood = yes

		random_system_within_border = {
			limit = { exists = starbase }
			starbase = { save_event_target_as = spawn_location }
		}
		swarm_brood = yes

		if = {
			limit = {
				galaxy_percentage > 0.20
			}
			random_system_within_border = {
				limit = { exists = starbase }
				starbase = { save_event_target_as = spawn_location }
			}
			swarm_brood = yes
		}

		if = {
			limit = {
				galaxy_percentage > 0.40
			}
			random_system_within_border = {
				limit = { exists = starbase }
				starbase = { save_event_target_as = spawn_location }
			}
			swarm_brood = yes
		}

		if = {
			limit = {
				count_owned_ship = {
					limit = { is_ship_size = colony_ship_swarm }
					count < 3
				}
			}

			random_owned_planet = {
				limit = {
					has_orbital_bombardment = no
				}
				# Infestor
				create_fleet = {
					name = "NAME_Prethoryn_Infestor"
					effect = {
						set_owner = event_target:prethoryn
						create_ship = {
							name = random
							design = "NAME_Swarm_Colonizer"
							graphical_culture = "swarm_01"
						}
						set_location = {
							target = prev
							distance = 35
							angle = random
						}
					}
				}
			}
		}

		if = {
			limit = {
				count_owned_ship = {
					limit = { is_ship_size = construction_ship_swarm }
					count < 6
				}
			}

			random_owned_planet = {
				limit = {
					has_orbital_bombardment = no
				}
				# Constructor
				create_fleet = {
					name = "NAME_Prethoryn_Constructor"
					effect = {
						set_owner = event_target:prethoryn
						create_ship = {
							name = random
							design = "NAME_Swarm_Constructor"
							graphical_culture = "swarm_01"
						}
						set_location = {
							target = prev
							distance = 35
							angle = random
						}
						set_fleet_stance = evasive
					}
				}
			}
		}
	}
}

# Prethoryn Defeated
country_event = {
	id = crisis.211
	title = "crisis.211.name"
	desc = "crisis.211.desc"
	picture = GFX_evt_metropolis
	show_sound = event_celebration

	is_triggered_only = yes

	option = { # Spiritualist Response
		name = crisis.211.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Militarist Response
		name = crisis.211.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Materialist Response
		name = crisis.211.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Pacifist Response
		name = crisis.211.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Corporate Response
		name = crisis.211.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Default Response
		name = crisis.211.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_ethic = ethic_gestalt_consciousness
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Xenophobe Response
		name = crisis.211.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
	}
	option = { # Xenophile Response
		name = crisis.211.h
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	
	after = {
		add_modifier = {
			modifier = "prethoryn_defeated"
			days = 3600
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
		end_event_chain = "prethoryn_scourge_chain"
	}
}

# Brood-Queen Relic Activation
country_event = {
	id = crisis.250
	title = "crisis.250.name"
	desc = "crisis.250.desc"
	picture = GFX_evt_unidentified_monster
	show_sound = event_mystic_reveal

	is_triggered_only = yes

	option = {
		name = GOOD
		hidden_effect = {
			capital_scope = {
				create_fleet = {
					name = "NAME_Loyal_Brood"
					effect = {
						set_owner = root
						while = {
							count = 12
							create_ship = {
								name = random
								prefix = no
								design = "NAME_Swarm_Large"
								graphical_culture = "swarm_01"
							}
						}
						while = {
							count = 32
							create_ship = {
								name = random
								prefix = no
								design = "NAME_Swarm_Small"
								graphical_culture = "swarm_01"
							}
						}
						set_location = {
							target = prev
							distance = 45
							angle = random
						}
					}
					settings = {
						can_change_composition = yes
						uses_naval_capacity = no
						can_disband = yes
					}
				}
			}
		}
	}
}

# Unbidden
# Extradimensional Invasion Begins (HIDDEN)
country_event = {
	id = crisis.1000
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	immediate = {
		set_crisis_sound = extradimensional_crisis_ambient_stage_1
		set_crisis_stage_1 = yes
		create_country = {
			name = "NAME_Portal_Holder_1"
			type = portal_holder
			flag = {
				icon= {
					category = "special"
					file = "extradimensional_01.dds"
				}
				background= {
					category = "backgrounds"
					file = "circle.dds"
				}
				colors={
					"black"
					"black"
					"null"
					"null"
				}
			}
			effect = {
				save_global_event_target_as = portal_holder_1
				every_playable_country = {
					establish_communications_no_message = event_target:portal_holder_1
				}
			}
		}
		awaken_guardians_of_the_galaxy = yes

		endgame_telemetry = extradimensional
		set_global_flag = extradimensional_invasion_happened
		set_global_flag = galactic_crisis_happened
		if = {
			limit = {
				NOT = { any_system = { has_star_flag = extradimensional_origin_system } }
			}
			random_system = {
				limit = {
					NOT = {
						any_country = {
							OR = {
								is_country_type = fallen_empire
								is_country_type = awakened_fallen_empire
							}
							any_system_within_border = {
								is_same_value = prev
							}
						}
					}
				}
				set_star_flag = extradimensional_origin_system
				save_event_target_as = extradimensional_system
				random_system_planet = {
					create_species = {
						name = "NAME_Unbidden"
						class = EXD
						portrait = exd1
						traits = random
						effect = { save_event_target_as = extradimensional_species }
					}
					create_country = {
						name = "NAME_Unbidden"
						type = "extradimensional"
						species = event_target:extradimensional_species
						name_list = "Extradimensional"
						effect = { set_country_flag = unbidden }
						flag = {
							icon= {
								category = "special"
								file = "extradimensional_01.dds"
							}
							background= {
								category = "backgrounds"
								file = "circle.dds"
							}
							colors={
								"indigo"
								"blue"
								"null"
								"null"
							}
						}
						effect = {
							create_ship_design = { design = "NAME_Void_Shaper" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Unbidden_Anchor" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Unbidden_Starbase" }
							add_ship_design = last_created_design
							save_global_event_target_as = extradimensionals
							establish_communications_no_message = event_target:portal_holder_1
							set_faction_hostility = {
								target = event_target:portal_holder_1
								set_hostile = no
							}
							set_graphical_culture = extra_dimensional_01
							save_event_target_as = extradimensionals
						}
					}
					event_target:extradimensionals = {
						create_fleet = {
							name = "NAME_Dimensional_Portal"
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Unbidden_Portal"
									graphical_culture = "extra_dimensional_01"
									effect = { set_ship_flag = unbidden_portal }
								}
								set_location = {
									target = PREVPREV
									distance = 40
									angle = random
								}
								save_event_target_as = dimensional_portal
								fleet_event = { id = crisis.1003 days = 15 } # Second Fleet Arrives
								fleet_event = { id = crisis.1003 days = 30 } # Third Fleet Arrives
								fleet_event = { id = crisis.1003 days = 55 } # Fourth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 90 } # Fifth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 180 } # Sixth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 265 } # Seventh Fleet Arrives
								fleet_event = { id = crisis.1003 days = 340 } # Eight Fleet Arrives
								fleet_event = { id = crisis.1003 days = 425 } # Ninth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 550 } # Tenth Fleet Arrives
								fleet_event = { id = crisis.1006 days = 20 } # First Constructor Arrives
								fleet_event = { id = crisis.1006 days = 25 } # Second Constructor Arrives
								fleet_event = { id = crisis.1006 days = 160 } # Third Constructor Arrives
								fleet_event = { id = crisis.1006 days = 310 } # Fourth Constructor Arrives
								event_target:extradimensionals = { country_event = { id = crisis.1260 days = 350 } } # Spawn Cycle starts
								#set_owner = event_target:portal_holder_1 #when first anchor built
							}
						}
						create_leader = {
							class = admiral
							species = event_target:extradimensional_species
							name = random
							skill = 3
							traits = {
								trait = leader_trait_ethereal
							}
						}
						create_fleet = {
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Revenant"
									graphical_culture = "extra_dimensional_01"
								}
								assign_leader = last_created_leader
								while = {
									count = 20
									create_ship = {
										name = random
										design = "NAME_Revenant"
										graphical_culture = "extra_dimensional_01"
									}
								}
								while = {
									count = 30
									create_ship = {
										name = random
										design = "NAME_Phantom"
										graphical_culture = "extra_dimensional_01"
									}
								}
								while = {
									count = 45
									create_ship = {
										name = random
										design = "NAME_Wraith"
										graphical_culture = "extra_dimensional_01"
									}
								}
								set_location = {
									target = event_target:dimensional_portal
									distance = 5
									angle = random
								}
								set_fleet_stance = aggressive
								set_aggro_range = 500
								set_aggro_range_measure_from = self
							}
						}
					}
				}
				if = {
					limit = { exists = starbase }
					starbase = { fleet = { destroy_fleet = this } }
				}
				create_starbase = {
					size = starbase_exd
					owner = event_target:extradimensionals
				}
			}
		}
		else = {
			random_system = {
				limit = {
					has_star_flag = extradimensional_origin_system
				}
				save_event_target_as = extradimensional_system
				random_system_planet = {
					create_species = {
						name = "NAME_Unbidden"
						class = EXD
						portrait = exd1
						traits = random
						effect = { save_event_target_as = extradimensional_species }
					}
					create_country = {
						name = "NAME_Unbidden"
						type = "extradimensional"
						species = event_target:extradimensional_species
						name_list = "Extradimensional"
						effect = { set_country_flag = unbidden }
						flag = {
							icon= {
								category = "special"
								file = "extradimensional_01.dds"
							}
							background= {
								category = "backgrounds"
								file = "circle.dds"
							}
							colors={
								"indigo"
								"blue"
								"null"
								"null"
							}
						}
						effect = {
							create_ship_design = { design = "NAME_Void_Shaper" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Unbidden_Anchor" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Unbidden_Starbase" }
							add_ship_design = last_created_design
							save_global_event_target_as = extradimensionals
							establish_communications_no_message = event_target:portal_holder_1
							set_faction_hostility = {
								target = event_target:portal_holder_1
								set_hostile = no
							}
							set_graphical_culture = extra_dimensional_01
							save_event_target_as = extradimensionals
						}
					}
					event_target:extradimensionals = {
						create_fleet = {
							name = "NAME_Dimensional_Portal"
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Unbidden_Portal"
									graphical_culture = "extra_dimensional_01"
									effect = { set_ship_flag = unbidden_portal }
								}
								set_location = {
									target = PREVPREV
									distance = 40
									angle = random
								}
								save_event_target_as = dimensional_portal
								fleet_event = { id = crisis.1003 days = 15 } # Second Fleet Arrives
								fleet_event = { id = crisis.1003 days = 30 } # Third Fleet Arrives
								fleet_event = { id = crisis.1003 days = 55 } # Fourth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 90 } # Fifth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 180 } # Sixth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 265 } # Seventh Fleet Arrives
								fleet_event = { id = crisis.1003 days = 340 } # Eight Fleet Arrives
								fleet_event = { id = crisis.1003 days = 425 } # Ninth Fleet Arrives
								fleet_event = { id = crisis.1003 days = 550 } # Tenth Fleet Arrives
								fleet_event = { id = crisis.1006 days = 20 } # First Constructor Arrives
								fleet_event = { id = crisis.1006 days = 25 } # Second Constructor Arrives
								fleet_event = { id = crisis.1006 days = 160 } # Third Constructor Arrives
								fleet_event = { id = crisis.1006 days = 310 } # Fourth Constructor Arrives
								event_target:extradimensionals = { country_event = { id = crisis.1260 days = 350 } } # Spawn Cycle starts
								#set_owner = event_target:portal_holder_1 #when first anchor built
							}
						}
						create_leader = {
							class = admiral
							species = event_target:extradimensional_species
							name = random
							skill = 3
							traits = {
								trait = leader_trait_ethereal
							}
						}
						create_fleet = {
							effect = {
								set_owner = PREV
								create_ship = {
									name = random
									design = "NAME_Revenant"
									graphical_culture = "extra_dimensional_01"
								}
								assign_leader = last_created_leader
								while = {
									count = 20
									create_ship = {
										name = random
										design = "NAME_Revenant"
										graphical_culture = "extra_dimensional_01"
									}
								}
								while = {
									count = 30
									create_ship = {
										name = random
										design = "NAME_Phantom"
										graphical_culture = "extra_dimensional_01"
									}
								}
								while = {
									count = 45
									create_ship = {
										name = random
										design = "NAME_Wraith"
										graphical_culture = "extra_dimensional_01"
									}
								}
								set_location = {
									target = event_target:dimensional_portal
									distance = 5
									angle = random
								}
								set_fleet_stance = aggressive
								set_aggro_range = 500
								set_aggro_range_measure_from = self
							}
						}
					}
				}
				if = {
					limit = { exists = starbase }
					starbase = { fleet = { destroy_fleet = this } }
				}
				create_starbase = {
					size = starbase_exd
					owner = event_target:extradimensionals
				}
			}
		}
		observer_event = { id = observer.34 }
		# make portal invincible
		event_target:extradimensionals = {
			random_owned_ship = { ship_event = { id = crisis.1280 } }
		}
		every_country = {
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
				intel_level = {
					level = high
					system = event_target:extradimensional_system
				}
			}
			country_event = { id = crisis.1007 }
		}
		every_country = {
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
				NOT = {
					intel_level = {
						level = high
						system = event_target:extradimensional_system
					}
				}
			}
			country_event = { id = crisis.1008 }
		}
		every_country = {
			limit = { has_country_flag = spy_orb_spots_crisis }
			country_event = { id = megaexpanded.7  days = 5 }
		}
	}
}

# Notification (High Intel)
country_event = {
	id = crisis.1007
	title = "crisis.1007.name"
	desc = "crisis.1007.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:extradimensional_system

	is_triggered_only = yes

	after = {
		begin_event_chain = {
			event_chain = "extradimensional_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.1
			name = "extradimensional_invasion_1_poi"
			desc = "extradimensional_invasion_1_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:extradimensional_system
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.4
			name = "extradimensional_invasion_4_poi"
			desc = "extradimensional_invasion_4_poi_desc"
			event_chain = "extradimensional_invasion_chain"
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain"
				counter = "dimensional_anchors_1"
				amount = 1
			}
			country_event = { id = crisis.1010 }
		}
	}

	option = {
		name = crisis.18.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
	}
	option = {
		name = crisis.1007.a
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	option = {
		name = crisis.1007.b
		trigger = {
			has_ethic = "ethic_fanatic_authoritarian"
		}
	}
	option = {
		name = crisis.18.j
		trigger = {
			has_ethic = "ethic_fanatic_egalitarian"
		}
	}
	option = {
		name = crisis.18.h
		trigger = {
			has_ethic = ethic_gestalt_consciousness
		}
	}
}

# Notification
country_event = {
	id = crisis.1008
	title = "crisis.1008.name"
	desc = "crisis.1008.desc"
	picture = GFX_evt_physics_research
	show_sound = event_alien_signal

	is_triggered_only = yes

	option = {
		name = crisis.1008.a
		hidden_effect = {
			if = {
				limit = {
					OR = {
						has_megastructure = spy_orb_4
						has_megastructure = spy_orb_restored
					}
				}
				country_event = { id = crisis.1009 days = 3 }
			}
			else = { country_event = { id = crisis.1009 days = 30 } }
		}
	}
}

# Threat Identified
country_event = {
	id = crisis.1009
	title = "crisis.1007.name"
	desc = "crisis.1009.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started

	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_origin_system }
			save_event_target_as = extradimensional_system
		}
	}

	after = {
		begin_event_chain = {
			event_chain = "extradimensional_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.1
			name = "extradimensional_invasion_1_poi"
			desc = "extradimensional_invasion_1_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:extradimensional_system
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.4
			name = "extradimensional_invasion_4_poi"
			desc = "extradimensional_invasion_4_poi_desc"
			event_chain = "extradimensional_invasion_chain"
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain"
				counter = "dimensional_anchors_1"
				amount = 1
			}
			country_event = { id = crisis.1010 }
		}
	}

	option = {
		name = crisis.18.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
	}
	option = {
		name = crisis.1007.a
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	option = {
		name = crisis.1007.b
		trigger = {
			has_ethic = "ethic_fanatic_authoritarian"
		}
	}
	option = {
		name = crisis.18.j
		trigger = {
			has_ethic = "ethic_fanatic_egalitarian"
		}
	}
	option = {
		name = crisis.18.h
		trigger = {
			has_ethic = ethic_gestalt_consciousness
		}
	}
}

# Extradimensionals Defeated
country_event = {
	id = crisis.1271
	title = "crisis.1271.name"
	desc = "crisis.1271.desc"
	picture = GFX_evt_metropolis
	show_sound = event_celebration

	is_triggered_only = yes

	immediate = {
		end_event_chain = "extradimensional_invasion_chain"
		end_event_chain = "extradimensional_invasion_chain_2"
		end_event_chain = "extradimensional_invasion_chain_3"
	}

	option = { # Spiritualist Response
		name = crisis.1271.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Militarist Response
		name = crisis.1271.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Materialist Response
		name = crisis.1271.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Pacifist Response
		name = crisis.1271.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Corporate Response
		name = crisis.1271.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Default Response
		name = crisis.211.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_authority = auth_machine_intelligence
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = { # Xenophobe Response
		name = crisis.1271.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
	}
	option = { # Xenophile Response
		name = crisis.1271.h
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	
	after = {
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
}

# Contingency
# Crisis Initiated
country_event = {
	id = crisis.2005
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	immediate = {
		set_global_flag = ai_invasion_happened
		set_global_flag = ai_ghost_signal
		endgame_telemetry = ai_revolt

		observer_event = { id = observer.41 }
		# The Ghost Signal
		every_country = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				NOT = { has_country_flag = spy_orb_spots_crisis }
			}
			country_event = { id = crisis.2010 }
		}
		every_country = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				has_country_flag = spy_orb_spots_crisis
			}
			country_event = { id = megaexpanded.9 }
			country_event = { id = megaexpanded.10 days = 1200 random = 200 }
			country_event = { id = megaexpanded.11 days = 1470 random = 200 }
		}
		# Synths Act Strange
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2006 days = 100 random = 200 }
		}
		# Machine Empire Pops Act Strange
		every_country = {
			limit = { has_authority = auth_machine_intelligence }
			country_event = { id = crisis.2500 days = 100 random = 200 }
		}
		# Synths Disappear
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2007 days = 400 random = 200 }
		}
		# Synthetic Disappearances
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2020 days = 700 random = 200 }
		}
		# The Summons
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2021 days = 1000 random = 200 }
		}
		# The Arrival
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2022 days = 1400 }
		}
		# First Machine World
		random_planet = {
			limit = { has_planet_flag = machine_world_1 }
			planet_event = { id = crisis.2025 days = 1450 random = 10 }
		}
		# Second Machine World
		random_planet = {
			limit = { has_planet_flag = machine_world_2 }
			planet_event = { id = crisis.2026 days = 1500 random = 10 }
		}
		# Third Machine World
		random_planet = {
			limit = { has_planet_flag = machine_world_3 }
			planet_event = { id = crisis.2027 days = 1550 random = 10 }
		}
		# Fourth Machine World
		random_planet = {
			limit = { has_planet_flag = machine_world_4 }
			planet_event = { id = crisis.2028 days = 1600 random = 10 }
		}
		# Synth Infiltration
		every_country = {
			limit = { is_country_type = default }
			if = {
				limit = {
					NOR = {
						has_authority = auth_hive_mind
						has_authority = auth_machine_intelligence
						owner_species = { has_trait = trait_psionic }
					}
				}
				country_event = { id = crisis.2085 days = 1800 random = 100 }
			}
			if = {
				limit = { has_authority = auth_hive_mind }
				country_event = { id = crisis.2086 days = 1800 random = 100 }
			}
			if = {
				limit = { owner_species = { has_trait = trait_psionic } }
				country_event = { id = crisis.2087 days = 1800 random = 100 }
			}
			if = {
				limit = { has_authority = auth_machine_intelligence }
				country_event = { id = crisis.2313 days = 1800 random = 100 }
			}
		}
	}
}