# Original File
#
# Calvitix Check  3.4.4  26.06.2022
#
# Merge with Skalla Ai's Overhaul
# Merge with Starnet AI 26.06.2022
#

## Categories used in this file must have use_for_ai_budget = yes defined in economic_categories ##
## It is possible to have multiple entries with the same category and resource ##

#################
## Expenditure ##
#################
alloys_expenditure_buffer = { # Buffer, will not be spent
	resource = alloys
	type = expenditure
	category = buffer

	potential = {
		always = no
	}

	fraction = {
		weight = 0
	}
}

alloys_expenditure_trade = {
	resource = alloys 
	type = expenditure
	category = trade
	
	potential = {
		years_passed > 15
	}
	
	fraction = {
		weight = 0.5
	}
	static_min = {
		base = 0
		modifier = {
			add = 500
			resource_stockpile_compare = {
				resource = alloys
				value > 1000
			}
			resource_stockpile_compare = {
				resource = energy
				value < 300
			}
			resource_income_compare = {
				resource = energy 
				value < -10
				}
			years_passed > 20
		}
		modifier = {
			add = 2000
			resource_stockpile_compare = {
				resource = alloys
				value > 2000
			}
			resource_stockpile_compare = {
				resource = energy
				value < 300
			}
			resource_income_compare = {
				resource = energy 
				value < -100
				}
			years_passed > 40
		}
	}
}

alloys_expenditure_ships_rush ={
	resource = alloys
	type = expenditure
	category = ships
	potential = {
		has_country_flag = ferocious_rusher
		any_neighbor_country = {
			is_country_type = default
			not = {
				has_truce = prev
			}
		}
	}
	fraction = {
		weight = 0.5
	}
	static_min = {
		base = 500
	}
}

alloys_expenditure_earlyships ={
	resource = alloys
	type = expenditure
	category = ships
	potential = {
		years_passed < 10
		or = {
			years_passed > 3
			has_country_flag = str_disable_corvettes
		}
	}
	fraction = {
		weight = 0.4
	}
	static_min = {
		base = 0
		modifier = {
			add = 100
			resource_stockpile_compare = {
				resource = alloys
				value > 160
			}
			has_ai_expansion_plan = no
			ai_colonize_plans < 1
		}
	}
}

alloys_expenditure_ships = {
	resource = alloys
	type = expenditure
	category = ships

	potential = {
		can_you_please_stop_building_ships = no
	}

	fraction = {
		weight = 0.6

		# spend more alloys building ships while at war
		modifier = {
			factor = 2
			OR = {
				recently_lost_war = yes
				is_at_war = yes
			}
		}
		# If we want to colonize and are at peace then prio that
		modifier = {
			factor = 0.25
			AND = {
				ai_colonize_plans > 0
				is_at_war = no
			}
		}

		# spend less alloys on ships if over capacity
		modifier = {
			factor = 0.5
			used_naval_capacity_percent >= 1.0
		}

		modifier = {
			factor = 5
			used_naval_capacity_percent < 1.0
			OR = {
				any_neighbor_country = {
					has_ascension_perk = ap_become_the_crisis
				}
				any_country = {
					is_crisis_faction = yes
				}
			}
		}
	}

	static_min = {
		base = 0
		modifier = {
			add = 140
			years_passed > 15
			used_naval_capacity_percent < 0.4
			ai_colonize_plans < 1
		}
		modifier = {
			add = 200
			used_naval_capacity_percent < 0.5
			years_passed > 17
			ai_colonize_plans < 1
		}
		modifier = {
			add = 400
			used_naval_capacity_percent < 0.4
			resource_stockpile_compare = {
				resource = influence
				value > 250
			}
			has_ai_expansion_plan = no
			ai_colonize_plans < 1
			any_neighbor_country = {
				is_country_type = default
				prev = {
					is_hostile_to = prev
					is_unfriendly_to = prev
				}
			}
		}
		modifier = {
			add = 600
			resource_stockpile_compare = {
				resource = alloys
				value > 2000
			}
			used_naval_capacity_percent < 0.7
		}
		modifier = {
			add = 400
			resource_stockpile_compare = {
				resource = alloys
				value > 2000
			}
		}
	}
}

alloys_expenditure_ships_neighbour = {
	resource = alloys 
	type = expenditure
	category = ships
	
	potential = {
		or =  {
		or = {
		ai_colonize_plans < 1
		resource_stockpile_compare = {
			resource = alloys
			value > 600
		}	
		}
		any_relation = {
				or = {
					is_ai = no
					is_hostile_to = prev
					is_unfriendly_to = prev	
				}
			}
		}
		scared_of_neighbour = yes
		can_you_please_stop_building_ships = no
	}
	
	fraction = {
		weight = 0.7
	}	
	static_min = {
		base = 1000
		modifier = {
			add = 2000
			years_passed > 40
		}
		modifier = {
			add = 3000
			years_passed > 100
		}
	}
}

alloys_expenditure_ships_wartime = {
	resource = alloys 
	type = expenditure
	category = ships
	
	potential = {
		can_you_please_stop_building_ships = no
		or = { 
			is_at_war = yes
			and = {
				prepare_for_war = yes
				or = {
					has_country_flag = ferocious_rusher
					ai_colonize_plans < 1
				}
			}
		}
	}

	fraction = {
		weight = 0.7
		}
	static_min = {
		base = 10000
	}
}

alloys_expenditure_ships_later = {
	resource = alloys 
	type = expenditure
	category = ships
	
	potential = {
		years_passed > 15
		safespace = no
		can_you_please_stop_building_ships = no
	}
	
	fraction = {
		weight = 0.3
	}	
	static_min = {
		base = 800
	}
}


alloys_expenditure_ships_latefleet = {
	resource = alloys 
	type = expenditure
	category = ships

	potential = {
	has_technology = tech_energy_torpedoes_1
	can_you_please_stop_building_ships = no
				}
	
	fraction = {
		weight = 0.7
				}
	static_min = {
		base = 3000
			}		
}


alloys_expenditure_ships_battleships = {
	resource = alloys 
	type = expenditure
	category = ships
	
	potential = {
		has_technology = tech_energy_torpedoes_2
		can_you_please_stop_building_ships = no
	}
	
	fraction = {
		weight = 0.3
		}
	static_min = {
		base = 5000
	}
}

#alloys_expenditure_ships_early = {
	#resource = alloys 
	#type = expenditure
	#category = ships
	
	#potential = {
		#years_passed < 5
	#}
	
	#fraction = {
		#weight = 0
	#}	
	#static_min = {
		#base = 0
		#modifier = {
			#add = 60
			#is_difficulty = 5
		#}
		#modifier = {
			#add = 10 
			#is_difficulty < 5
		#}
		#modifier = {
			#add = 10
			#is_difficulty < 4
		#}
		#modifier = {
			#add = 10
			#is_difficulty < 3
		#}
		#modifier = {
			#add = 10
			#is_difficulty < 2
		#}
		#modifier = {
			#add = -6
			#or = {
				#has_valid_civic = civic_fanatic_purifiers
				#has_valid_civic = civic_machine_terminator
				#has_valid_civic = civic_hive_devouring_swarm
			#}
		#}
	#}
#}

alloys_expenditure_ship_upgrades = {
	resource = alloys
	type = expenditure
	category = ship_upgrades

	potential = {
		is_at_war = no
		nor = {
			any_relation = { is_crisis_faction = yes }
			has_global_flag = ai_invasion_ongoing
			has_global_flag = war_in_heaven_ongoing
			has_global_flag = extradimensional_invasion_happened 
			has_global_flag = ongoing_prethoryn_invasion
		} 
	}

	fraction = {
		weight = 0.2

		# spend more on ship upgrades if at capacity
		modifier = {
			factor = 4
			used_naval_capacity_percent >= 1.0
		}
	}
	
	static_min = {
		base = 0
		modifier = {
			add = 600
			stalemate = yes
			safespace = no
		}
		modifier = {
			add = 1000
			years_passed < @str_years_of_guaranteed_truce
		}
		modifier = {
			add = 600
			resource_stockpile_compare = {
				resource = alloys
				value > 1000
			}
		}
		modifier = {
			add = 1000
			resource_stockpile_compare = {
				resource = alloys
				value > 2000
			}
		}
		modifier = {
			add = 3000
			resource_stockpile_compare = {
				resource = alloys
				value > 3000
			}
		}
	}
}

alloys_expenditure_planets = {
	resource = alloys
	type = expenditure
	category = planets

	potential = {
		always = yes
	}

	fraction = {
		weight = 0.25  #0.5 in Starnet
	}

	static_min = {
		base = 1500 # 4500 #150 in 3.3b
	}

	#Ori 3.3b 
	#static_max = {
	#	base = 450
	#}
}

alloys_expenditure_starbases = {
	resource = alloys
	type = expenditure
	category = starbases

	potential = {
		nand = {
			has_country_flag = str_emergency_fleetbuilding_rush
			resource_stockpile_compare = {
				resource = alloys
				value < 500
			}
		}
		str_save_alloys_against_rush = no
		or = {
			years_passed < @str_years_of_extended_truce
			used_naval_capacity_percent > 0.5
			resource_stockpile_compare = {
				resource = influence
				value > 100
			}
		}
		NOT = {
			is_country_type = fallen_empire
		}
	}

	fraction = {
		weight = 0.3
		#Ori 3.3b spend more on starbase upgrades if at fleet cap
		modifier = {
			factor = 4
			used_naval_capacity_percent >= 1.0
		}

		# Reduce spending on claiming new systems if we have unclaimed planets
		modifier = {
			factor = 0.25
			ai_colonize_plans > 0
		}
	}
	static_min = {
		base = 120
		modifier = {
			add = 300
			or = {
			has_country_flag = ferocious_rusher
				ai_colonize_plans < 1
			}
			years_passed > 8
		}
		modifier = {
			add = 500
			or = {
			has_country_flag = ferocious_rusher
				ai_colonize_plans < 1
			}
			years_passed > 13
		}
		modifier = {
			add = 700
			resource_stockpile_compare = {
				resource = alloys
				value > 500
			}
		}
		modifier = {
			add = 1500
			resource_stockpile_compare = {
				resource = alloys
				value > 2000
			}
		}
		modifier = {
			add = 2000
			used_naval_capacity_percent > 0.9
			years_passed > 25
		}
		modifier = {
			add = 4000
			resource_stockpile_compare = {
				resource = alloys
				value > 4000
			}
		}
		modifier = {
			add = 1000
			num_ascension_perks > 2
		}
		modifier = {
			add = 700
			or = {
			has_country_flag = ferocious_rusher
				ai_colonize_plans < 1
			}
			years_passed > 22
		}
	}
}

alloys_expenditure_starbases_fallen_empires = {
	resource = alloys
	type = expenditure
	category = starbases

	potential = {
		is_country_type = fallen_empire
	}

	fraction = {
		weight = 0.2
	}
}

alloys_expenditure_starbases_expand = {
	resource = alloys
	type = expenditure
	category = starbases

	potential = {
		not = {
			has_country_flag = str_emergency_fleetbuilding_rush
		}
		str_save_alloys_against_rush = no
		has_ai_expansion_plan = yes
		highest_threat < 50
		NOR = {
			is_country_type = fallen_empire
			is_country_type = awakened_fallen_empire
			ai_colonize_plans > 0
		}
		has_resource = { type = influence amount > 75 }
	}

	fraction = {
		weight = 1.2  #0.2  #Calvitix
	}

	static_min = {  #3.3b
		base = 150
	}
}

alloys_expenditure_starbases_excess = {
	resource = alloys 
	type = expenditure
	category = starbases
	
	potential = {
		resource_stockpile_compare = {
			resource = alloys
			value > 2000
		}
		str_save_alloys_against_rush = no
	}
	
	fraction = {
		weight = 0
	}	
	static_min = {
		base = 1000
		modifier = {
			add = 2000
		resource_stockpile_compare = {
			resource = alloys
			value > 5000
		}
		}
	}
}
#alloys_expenditure_stations_base = {
#	resource = alloys 
#	type = expenditure
#	category = stations
	
#	potential = {
#		always = yes
#	}
	
#	fraction = {
#		weight = 0.15
#	}	
#}

#alloys_expenditure_stations_no_expand = {
#	resource = alloys 
#	type = expenditure
#	category = stations
#	
#	potential = {
#		has_ai_expansion_plan = no
#	}
#	
#	fraction = {
#		weight = 0.25
#	}	
#}

alloys_expenditure_colonies = {
	resource = alloys 
	type = expenditure
	category = colonies
	
	potential = {
		nand = {
			has_country_flag = str_emergency_fleetbuilding_rush
			resource_stockpile_compare = {
				resource = alloys
				value < 500
			}
		}
		not = {
			has_country_flag = ferocious_rusher
		}
		or = {
			years_passed < 15
			ai_colonize_plans > 0
		}
		nand = {
			is_at_war = yes
			resource_stockpile_compare = {
				resource = alloys
				value < 300
			}
			used_naval_capacity_percent < 1
		}
	}

	fraction = {
		weight = 1
	}

	static_min = {
		base = 400
	}

	static_max = {
		base = 450
	}
}

alloys_expenditure_colonies_expand = {
	resource = alloys
	type = expenditure
	category = colonies

	potential = {
		is_machine_empire = no
		is_at_war = no
		ai_colonize_plans > 0
		OR = {
			AND = {
				is_lithoid_empire = no
				has_resource = { type = food amount > 400 }
				has_monthly_income = {
					resource = food
					value > 0
				}
			}
			AND = {
				is_lithoid_empire = yes
				has_resource = { type = minerals amount > 400 }
				has_monthly_income = {
					resource = minerals
					value > 0
				}
			}
		}
	}

	fraction = {
		weight = 0.5
	}

	static_min = {
		base = 200
	}

	static_max = {
		base = 250
	}
}

alloys_expenditure_colonies_expand_machine = {
	resource = alloys
	type = expenditure
	category = colonies

	potential = {
		is_machine_empire = yes
		is_at_war = no
		ai_colonize_plans > 0
	}

	fraction = {
		weight = 0.5
	}

	static_min = {
		base = 400
	}

	static_max = {
		base = 450
	}
}

alloys_expenditure_megastructures = {
	resource = alloys
	type = expenditure
	category = megastructures

	potential = {
		is_country_type = default
		is_at_war = no
		#can_build_megastructures = yes
		or = {
			has_galactic_wonders = yes
			has_technology = tech_strategic_coordination
			has_origin = origin_void_dwellers
		}
		ai_colonize_plans < 3
		str_ai_should_build_megastructures = yes
	}

	fraction = {
		weight = 0.4
		# increase budget if megastructures are unfinished
		modifier = {
			factor = 3
			any_owned_megastructure = {
				NOR = {
					is_megastructure_type = dyson_sphere_5
					is_megastructure_type = dyson_sphere_restored
					is_megastructure_type = spy_orb_4
					is_megastructure_type = spy_orb_restored
					is_megastructure_type = think_tank_4
					is_megastructure_type = think_tank_restored
					is_megastructure_type = gateway_final
					is_megastructure_type = gateway_restored
					is_megastructure_type = matter_decompressor_4
					is_megastructure_type = matter_decompressor_restored
					is_megastructure_type = strategic_coordination_center_3
					is_megastructure_type = strategic_coordination_center_restored
					is_megastructure_type = mega_art_installation_3
					is_megastructure_type = mega_art_installation_restored
					is_megastructure_type = interstellar_assembly_4
					is_megastructure_type = interstellar_assembly_restored
					is_megastructure_type = mega_shipyard_3
					is_megastructure_type = mega_shipyard_restored
					is_megastructure_type = lgate_base
				}
			}
		}
	}

	static_min = {
		base = 30000 # current max alloy cost for a stage
	}
	
#	static_max = {
#		base = 20000 # current max alloy cost for a stage
#	}
}

alloys_expenditure_habitats = {
	resource = alloys
	type = expenditure
	category = megastructures_habitat

	potential = {
		ai_should_build_habitats = yes
		str_ai_should_build_habitats = yes
	}

	fraction = {
		weight = 0.2
		modifier = {
			factor = 2.5
			has_origin = origin_void_dwellers
		}
		modifier = {
			factor = 5
			has_origin = origin_void_dwellers
			count_owned_planet = {
				limit = { is_planet_class = pc_habitat }
				count < 4
			}
		}
		modifier = {
			factor = 2
			OR = {
			has_origin = origin_void_dwellers
				capital_scope = { #Starnet AI
					is_a_habitable_planet_megastructure = yes
				}
				years_of_peace = {
					value > 15
				}
			}
			count_owned_planet = {
				limit = { is_planet_class = pc_habitat }
				count < 12
			}
		}
	}

	static_min = {
		base = 1000
	}
	static_max = {
		base = 1500
	}
}

alloys_expenditure_decisions = {
	resource = alloys
	type = expenditure
	category = decisions
	potential = {
		OR = {
			has_technology = tech_habitat_2
			has_technology = tech_mega_engineering
		}
		any_owned_planet = {
			OR = {
				AND = {
					is_planet_class = pc_habitat
					NOT = { has_planet_flag = advanced_habitat_2 }
					root = { has_technology = tech_habitat_2 }
				}
				AND = {
					is_planet_class = pc_shattered_ring_habitable
					num_uncleared_blockers < 1
					root = { has_technology = tech_mega_engineering }
				}
			}
		}
		# only consider these kinds of decisions when "wealthy"
		has_resource = {
			type = alloys
			amount > 5000
		}
	}
	fraction = {
		weight = 0.20
	}
	# based on habitat / restore ring
	static_max = {
		base = 2000
		modifier = {
			add = 1000
			has_technology = tech_habitat_3
			any_owned_planet = {
				has_planet_flag = advanced_habitat
				NOT = { has_planet_flag = advanced_habitat_2 }
			}
		}
		modifier = {
			add = 8000
			has_technology = tech_mega_engineering
			any_owned_planet = {
				is_planet_class = pc_shattered_ring_habitable
				num_uncleared_blockers < 1
			}
		}
	}
}

############
## Upkeep ##
############
alloys_upkeep_buffer = {	# Buffer, will not be spent
	resource = alloys
	type = upkeep
	category = buffer

	potential = {
		always = yes
	}

	fraction = {
		weight = 0.3
	}
}

alloys_upkeep_ships = {
	resource = alloys
	type = upkeep
	category = ships

	potential = {
		or = {
			years_passed > @str_years_of_guaranteed_truce
			has_country_flag = str_need_to_defend_against_rush 
		is_at_war = yes
			resource_stockpile_compare = {
				resource = alloys
				value > 5000 #12000
			}
		} 
	}

	fraction = {
		weight = 1
	}
}

alloys_upkeep_planets = {
	resource = alloys
	type = upkeep
	category = planets

	potential = {
		always = yes
	}

	fraction = {
		weight = 0.30
	}
}

alloys_upkeep_armies = {
	resource = alloys
	type = upkeep
	category = armies_for_alloys_and_food

	potential = {
		OR = {
			is_machine_empire = yes
			count_owned_army = {
				count >= 1
				limit = { 
					OR = {
						army_type = robotic_army
						army_type = machine_assault_1
						army_type = machine_assault_2
						army_type = machine_assault_3
					}
				}
			}
		}
	}

	fraction = {
		weight = 0.25
	}
}

alloys_expenditure_armies = {
	resource = alloys
	type = expenditure
	category = armies_for_alloys_and_food

	potential = {
		is_lithoid_empire = no
	}

	fraction = {
		weight = 0.01

		modifier = {
			factor = 10
			NOT = {
				count_owned_army = {
					count >= @armies_for_declaring_war
					limit = {
						is_defensive_army = no
					}
				}
			}
		}

		modifier = {
			factor = 2
			OR = {
				any_neighbor_country = {
					has_ascension_perk = ap_become_the_crisis
				}
				any_country = {
					is_crisis_faction = yes
				}
			}
		}
	}
}

alloys_expenditure_armies_threatened = {
	resource = alloys
	type = expenditure
	category = armies_for_alloys_and_food

	potential = {
		highest_threat > 20
		is_lithoid_empire = no
	}

	fraction = {
		weight = 0.10
	}
}